# 選手権アプリケーション 要件定義書

## 1. システム概要

### 1.1 アプリケーションの目的
Twitter上で坊主(@bozu_108)が開催している「選手権」を、誰でも主催・参加できるプラットフォームとして提供する。

「選手権」とは：
- 主催者が「あるある」などのお題を投稿
- 一般参加者が回答を投稿（テキスト + 画像）
- いいね・コメントで評価
- 主催者が最優秀賞・入賞・特別賞を選定

### 1.2 技術スタック
- **フロントエンド（モバイル）**: Flutter
- **バックエンド**: Cloud Run (Hono)
- **データベース**: Cloud SQL (MySQL)
- **ストレージ**: Cloud Storage (画像保存)
- **認証**: Firebase Authentication

### 1.3 アーキテクチャ
```
[Flutter App] 
    ↓ REST API
[Cloud Run (Hono)]
    ↓
[Cloud SQL (MySQL)] + [Cloud Storage]
    ↑
[Firebase Auth]
```

---

## 2. ユーザー要件

### 2.1 ユーザーの役割
全ユーザーが以下の両方の役割を持つ：
- **主催者**: 選手権を作成し、受賞作品を選定
- **参加者**: 選手権に回答を投稿

### 2.2 主要なユースケース

#### 2.2.1 選手権の作成・運営（主催者）
1. 選手権を作成（タイトル、説明文、募集期間を設定）
2. 参加者からの回答を待つ（募集中）
3. 締切後、回答を選定（選定中）
4. 受賞作品に賞を付与し、総評を投稿
5. 結果を発表（結果発表）

#### 2.2.2 選手権への参加（参加者）
1. 選手権一覧から気になるものを選ぶ
2. 回答を投稿（テキスト + 画像）
3. 他の回答にいいね・コメント
4. 結果発表を待つ

---

## 3. 機能要件

### 3.1 選手権機能

#### 3.1.1 選手権作成
- **入力項目**:
  - タイトル（必須、50文字以内）
  - 説明文（必須、500文字以内）
  - 募集期間（デフォルト: 1週間、最長: 2週間）
- **制約**:
  - 認証済みユーザーのみ作成可能

#### 3.1.2 選手権のライフサイクル

```
[募集中]
  ↓ 締切日時を過ぎると自動遷移
[選定中]
  ↓ 主催者が「結果発表」ボタンを押す
[結果発表]
```

**各状態での挙動**:

| 状態 | 回答投稿 | 回答編集 | いいね | コメント | 受賞設定 | 結果発表 |
|------|----------|----------|--------|----------|----------|----------|
| 募集中 | ○ | ○ | ○ | ○ | × | × |
| 選定中 | × | × | ○ | ○ | ○（主催者のみ） | ○（主催者のみ） |
| 結果発表 | × | × | ○ | ○ | × | × |

#### 3.1.3 選手権の状態遷移操作
- **強制終了**: 主催者が締切日を「現在時刻」に変更することで、募集中→選定中へ強制遷移
- **結果発表**: 主催者が明示的に「結果発表」ボタンを押すことで遷移
- **削除**: 選手権の削除は不可能

#### 3.1.4 選手権一覧・検索
- **フィルタ**:
  - 募集中のみ
  - 終了済み（選定中 + 結果発表）
- **ソート**:
  - 新着順
  - 人気順（回答数、いいね数、コメント数などから算出）
- **表示**:
  - タイトル、説明文（抜粋）、主催者名、募集期間、回答数、いいね総数

#### 3.1.5 統計情報（主催者向け）
選定中の選手権において、主催者は以下の統計を確認できる：
- 回答数（トップに表示）
- 回答一覧（スコア順にソート）
  - スコア = いいね数 + コメント数 × 0.5（重みは調整可能）

#### 3.1.6 選定中アラート
主催者が選定中の選手権を持っている場合、アプリの各ページで「※選定が必要なお題があります」という小さなアラートを表示

---

### 3.2 回答機能

#### 3.2.1 回答投稿
- **入力項目**:
  - テキスト（必須、300文字以内）
  - 画像（任意、最大10MB、推奨アスペクト比 9:16）
- **制約**:
  - 募集中の選手権のみ投稿可能
  - 1ユーザーが1選手権に複数回答可能

#### 3.2.2 回答編集
- **編集可能項目**: テキスト、画像
- **条件**: 募集中の選手権のみ編集可能
- **削除**: 不可（投稿後は削除できない）

#### 3.2.3 回答一覧表示
- **ソート**:
  - スコア順（いいね + コメント数）
  - 新着順
- **ページネーション**: 20件ずつ表示

#### 3.2.4 受賞設定（主催者のみ）
- **賞の種類**:
  - 最優秀賞（1個、必須）
  - 入賞（0〜3個）
  - 特別賞（0〜1個）
- **受賞コメント**: 各賞ごとに主催者がコメントを付与可能（300文字以内）

---

### 3.3 インタラクション機能

#### 3.3.1 いいね
- **対象**: 回答
- **制約**:
  - 1ユーザーが1回答に1回のみ
  - いいね後の取り消し不可
- **表示**: 回答ごとのいいね数

#### 3.3.2 コメント
- **対象**: 回答
- **入力**: テキスト（200文字以内）
- **返信機能**: なし（フラットなコメントリスト）
- **削除**: 不可

---

### 3.4 ユーザー管理機能

#### 3.4.1 認証
- Firebase Authenticationを使用
- ログイン方法: メール/パスワード、Googleアカウント等

#### 3.4.2 プロフィール
- **表示項目**:
  - 表示名（30文字以内）
  - アイコン画像
  - 自己紹介（200文字以内）
  - Twitterアカウントリンク（任意、URL形式）
- **編集**: 本人のみ可能

#### 3.4.3 投稿履歴
- 作成した選手権一覧
- 投稿した回答一覧

---

## 4. データモデル定義

### 4.1 エンティティ一覧

#### User（ユーザー）
- `id`: UUID (PK)
- `firebase_uid`: String (Unique, Firebase Auth UID)
- `display_name`: String (30文字以内)
- `avatar_url`: String (nullable)
- `bio`: Text (200文字以内, nullable)
- `twitter_url`: String (nullable)
- `created_at`: Timestamp
- `updated_at`: Timestamp

#### Championship（選手権）
- `id`: UUID (PK)
- `user_id`: UUID (FK -> User)
- `title`: String (50文字以内)
- `description`: Text (500文字以内)
- `status`: Enum ('募集中', '選定中', '結果発表')
- `start_at`: Timestamp
- `end_at`: Timestamp
- `summary_comment`: Text (1000文字以内, nullable, 総評)
- `created_at`: Timestamp
- `updated_at`: Timestamp

#### Answer（回答）
- `id`: UUID (PK)
- `championship_id`: UUID (FK -> Championship)
- `user_id`: UUID (FK -> User)
- `text`: Text (300文字以内)
- `image_url`: String (nullable)
- `award_type`: Enum (null, '最優秀賞', '入賞', '特別賞')
- `award_comment`: Text (300文字以内, nullable, 受賞コメント)
- `like_count`: Integer (デフォルト: 0)
- `comment_count`: Integer (デフォルト: 0)
- `created_at`: Timestamp
- `updated_at`: Timestamp

#### Like（いいね）
- `id`: UUID (PK)
- `answer_id`: UUID (FK -> Answer)
- `user_id`: UUID (FK -> User)
- `created_at`: Timestamp
- **制約**: (answer_id, user_id) でユニーク

#### Comment（コメント）
- `id`: UUID (PK)
- `answer_id`: UUID (FK -> Answer)
- `user_id`: UUID (FK -> User)
- `text`: Text (200文字以内)
- `created_at`: Timestamp

### 4.2 ER図（概念図）
```
User 1---* Championship (主催)
User 1---* Answer (投稿)
User 1---* Like
User 1---* Comment

Championship 1---* Answer
Answer 1---* Like
Answer 1---* Comment
```

---

## 5. API仕様（エンドポイント一覧）

### 5.1 認証
- すべてのエンドポイントはFirebase Auth トークンによる認証が必要（一部の読み取り系を除く）

### 5.2 選手権関連

| メソッド | エンドポイント | 説明 | 認証 |
|---------|---------------|------|------|
| GET | `/championships` | 選手権一覧取得（フィルタ、ソート可） | 不要 |
| GET | `/championships/:id` | 選手権詳細取得 | 不要 |
| POST | `/championships` | 選手権作成 | 必要 |
| PATCH | `/championships/:id/force-end` | 強制終了（締切を現在時刻に） | 必要（主催者のみ） |
| PATCH | `/championships/:id/publish-result` | 結果発表 | 必要（主催者のみ） |

### 5.3 回答関連

| メソッド | エンドポイント | 説明 | 認証 |
|---------|---------------|------|------|
| GET | `/championships/:id/answers` | 回答一覧取得 | 不要 |
| POST | `/championships/:id/answers` | 回答投稿 | 必要 |
| PATCH | `/answers/:id` | 回答編集 | 必要（投稿者のみ） |
| PATCH | `/answers/:id/award` | 受賞設定 | 必要（主催者のみ） |
| POST | `/answers/upload-url` | 画像アップロード用署名付きURL取得 | 必要 |

### 5.4 インタラクション

| メソッド | エンドポイント | 説明 | 認証 |
|---------|---------------|------|------|
| POST | `/answers/:id/like` | いいね追加 | 必要 |
| GET | `/answers/:id/comments` | コメント一覧取得 | 不要 |
| POST | `/answers/:id/comments` | コメント投稿 | 必要 |

### 5.5 ユーザー

| メソッド | エンドポイント | 説明 | 認証 |
|---------|---------------|------|------|
| GET | `/users/:id` | ユーザー情報取得 | 不要 |
| PATCH | `/users/me` | 自分のプロフィール更新 | 必要 |
| GET | `/users/:id/championships` | ユーザーが作成した選手権一覧 | 不要 |
| GET | `/users/:id/answers` | ユーザーが投稿した回答一覧 | 不要 |

---

## 6. 画面構成（主要画面）

### 6.1 ホーム画面
- 選手権一覧（タブ: 募集中 / 終了済み）
- ソート切り替え（新着順 / 人気順）
- 選定アラート（該当する場合）

### 6.2 選手権詳細画面
- 選手権情報（タイトル、説明、主催者、期間、ステータス）
- 回答一覧（ページネーション、ソート切り替え）
- 回答投稿ボタン（募集中のみ）
- 統計情報表示（主催者かつ選定中のみ）
- 結果発表ボタン（主催者かつ選定中のみ）

### 6.3 回答詳細画面
- 回答内容（テキスト、画像）
- いいねボタン、コメントボタン
- コメント一覧

### 6.4 選手権作成画面
- タイトル入力
- 説明文入力
- 募集期間設定（デフォルト1週間、最長2週間）

### 6.5 回答投稿/編集画面
- テキスト入力
- 画像アップロード（クライアント側で10MB以下に圧縮）

### 6.6 マイページ
- プロフィール表示・編集
- 自分が作成した選手権一覧
- 自分が投稿した回答一覧

---

## 7. 非機能要件

### 7.1 セキュリティ
- Firebase Authによるユーザー認証
- 署名付きURLによる画像アップロード
- SQL インジェクション対策（ORM使用）

### 7.2 パフォーマンス
- 画像はクライアント側で圧縮（10MB以内）
- 回答一覧はページネーション（20件ずつ）
- 適切なインデックス設計

### 7.3 運用・保守
- Cloud Runによる自動スケーリング
- エラーログの収集・監視
- データベースバックアップ

---

## 8. 制約事項・今後の拡張可能性

### 8.1 現時点で実装しない機能
- 外部SNS連携（Twitter等）
- リアルタイム通知
- コメントへの返信機能
- ユーザーのブロック・通報機能
- サムネイル画像の自動生成

### 8.2 将来的な拡張案
- タグ・カテゴリ機能
- キーワード検索
- ランキング機能
- プッシュ通知
- 選手権のシェア機能

---

## 9. 開発スコープ

### 9.1 MVP（最小viable製品）で実装する機能
- ユーザー認証・プロフィール管理
- 選手権のCRUD（削除除く）
- 回答のCRUD（削除除く）
- いいね・コメント機能
- 受賞設定・結果発表

### 9.2 優先度が高い追加機能
- 選手権の検索・フィルタリング
- 統計情報の可視化
- プロフィールの充実

---

## 10. 用語集

| 用語 | 説明 |
|------|------|
| 選手権 | お題を投稿し、回答を募集する企画 |
| 主催者 | 選手権を作成したユーザー |
| 参加者 | 選手権に回答を投稿するユーザー |
| 募集中 | 回答を受け付けている状態 |
| 選定中 | 回答の受付を終了し、主催者が受賞作品を選んでいる状態 |
| 結果発表 | 受賞作品が確定し、公開されている状態 |
| 強制終了 | 主催者が締切前に募集を終了する操作 |
| スコア | いいね数 + コメント数 × 0.5 で算出される評価値 |

---

以上